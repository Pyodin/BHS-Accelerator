---
parameters:
  - name: serviceConnection
  - name: backendAzureResourceGroupName
  - name: backendAzureStorageAccountName
  - name: backendAzureStorageAccountContainerName
  - name: backendAzureStorageAccountContainerKeyName
    default: terraform.tfstate
  - name: root_module_folder_relative_path
    default: '.'

steps:
  - task: AzureCLI@2
    displayName: 'Terraform Init'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e

        # Logout of Azure CLI to prove we are not using that auth method
        az logout

        # Export ARM variables using Azure DevOps built-in environment variables
        export ARM_TENANT_ID=$AZURESUBSCRIPTION_TENANT_ID
        export ARM_CLIENT_ID=$AZURESUBSCRIPTION_CLIENT_ID
        export ARM_OIDC_AZURE_SERVICE_CONNECTION_ID=$AZURESUBSCRIPTION_SERVICE_CONNECTION_ID
        export ARM_USE_OIDC="true"

        # Build terraform command arguments
        terraform_args=()
        terraform_args+=("-chdir=${{ parameters.root_module_folder_relative_path }}")
        terraform_args+=("init")
        terraform_args+=("-backend-config=storage_account_name=$BACKEND_AZURE_STORAGE_ACCOUNT_NAME")
        terraform_args+=("-backend-config=container_name=$BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME")
        terraform_args+=("-backend-config=key=$BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_KEY_NAME")
        terraform_args+=("-backend-config=use_azuread_auth=true")

        echo "Running: terraform ${terraform_args[@]}"
        terraform "${terraform_args[@]}"

    env:
      BACKEND_AZURE_RESOURCE_GROUP_NAME: ${{ parameters.backendAzureResourceGroupName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_NAME: ${{ parameters.backendAzureStorageAccountName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME: ${{ parameters.backendAzureStorageAccountContainerName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_KEY_NAME: ${{ parameters.backendAzureStorageAccountContainerKeyName }}
      ARM_OIDC_REQUEST_TOKEN: $(System.AccessToken)